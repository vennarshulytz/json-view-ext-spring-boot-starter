name: Release and Publish to Maven Central

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾
on:
  push:
    tags:
      - 'v*'

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  # Maven æ„å»ºå‚æ•°
  MAVEN_OPTS: "-Xmx1024m -XX:MaxMetaspaceSize=512m"
  # è·³è¿‡æµ‹è¯•çš„é€‰é¡¹ï¼ˆå‘å¸ƒæ—¶é€šå¸¸å·²ç»åœ¨ CI ä¸­æµ‹è¯•è¿‡ï¼‰
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

jobs:
  # ==========================================================================
  # Job 1: æ„å»ºå¹¶å‘å¸ƒ Core æ¨¡å—ï¼ˆJDK 8ï¼‰
  # ==========================================================================
  publish-core:
    name: ğŸ“¦ Publish Core Module (JDK 8)
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # Step 2: è®¾ç½® JDK 8 ç¯å¢ƒ
      # ----------------------------------------------------------------------
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      # ----------------------------------------------------------------------
      # Step 3: ç¼“å­˜ Maven ä¾èµ–
      # ----------------------------------------------------------------------
      - name: ğŸ“ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-core-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-core-
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # Step 4: ä» tag ä¸­æå–ç‰ˆæœ¬å·å¹¶æ›´æ–° pom.xml
      # ----------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Release Version: $VERSION"

      - name: ğŸ“ Update Version in pom.xml
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.VERSION }} -DgenerateBackupPoms=false -DprocessAllModules=true
          echo "âœ… All modules version updated to ${{ steps.version.outputs.VERSION }}"

      # ----------------------------------------------------------------------
      # Step 5: æ„å»ºå¹¶å‘å¸ƒ Core æ¨¡å—åˆ° Maven ä¸­å¤®ä»“åº“
      # ----------------------------------------------------------------------
      - name: ğŸš€ Build and Publish Core Module to Maven Central
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} clean deploy \
            -pl json-view-ext-core \
            -Prelease \
            -DskipTests=true \
            -Dgpg.passphrase=${{ secrets.MAVEN_GPG_PASSPHRASE }}
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      # ----------------------------------------------------------------------
      # Step 6: ä¸Šä¼ æ„å»ºäº§ç‰©
      # ----------------------------------------------------------------------
      - name: ğŸ“¤ Upload Core Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-artifacts
          path: |
            json-view-ext-core/target/*.jar
          retention-days: 5

  # ==========================================================================
  # Job 2: æ„å»ºå¹¶å‘å¸ƒ Spring Boot 1.x / Spring Boot 2.x æ¨¡å—ï¼ˆJDK 8ï¼‰
  # ==========================================================================
  publish-spring-boot:
    name: ğŸ“¦ Publish Spring Boot 1.x / Spring Boot 2.x Module (JDK 8)
    runs-on: ubuntu-latest
    # ç­‰å¾… Core æ¨¡å—å‘å¸ƒå®Œæˆ
    needs: [publish-core]

    steps:
      # ----------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # Step 2: è®¾ç½® JDK 8 ç¯å¢ƒ
      # ----------------------------------------------------------------------
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      # ----------------------------------------------------------------------
      # Step 3: ç¼“å­˜ Maven ä¾èµ–
      # ----------------------------------------------------------------------
      - name: ğŸ“ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-boot-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-boot-
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # Step 4: ä» tag ä¸­æå–ç‰ˆæœ¬å·å¹¶æ›´æ–° pom.xml
      # ----------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Release Version: $VERSION"

      - name: ğŸ“ Update Version in pom.xml
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.VERSION }} -DgenerateBackupPoms=false -DprocessAllModules=true
          echo "âœ… All modules version updated to ${{ steps.version.outputs.VERSION }}"

      # ----------------------------------------------------------------------
      # Step 5: æ„å»ºå¹¶å‘å¸ƒ Spring Boot 1.x / Spring Boot 2.x æ¨¡å—åˆ° Maven ä¸­å¤®ä»“åº“
      # ----------------------------------------------------------------------
      - name: ğŸš€ Build and Publish Spring Boot 1.x / Spring Boot 2.x to Maven Central
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} clean deploy \
            -pl json-view-ext-spring-boot-starter-javax \
            -Prelease \
            -DskipTests=true \
            -Dgpg.passphrase=${{ secrets.MAVEN_GPG_PASSPHRASE }}
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      # ----------------------------------------------------------------------
      # Step 6: ä¸Šä¼ æ„å»ºäº§ç‰©
      # ----------------------------------------------------------------------
      - name: ğŸ“¤ Upload Spring Boot 1.x / Spring Boot 2.x Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-artifacts
          path: |
            json-view-ext-spring-boot-starter-javax/target/*.jar
          retention-days: 5

  # ==========================================================================
  # Job 3: æ„å»ºå¹¶å‘å¸ƒ Spring Boot 3.x æ¨¡å—ï¼ˆJDK 17ï¼‰
  # ==========================================================================
  publish-spring-boot3:
    name: ğŸ“¦ Publish Spring Boot 3.x Module (JDK 17)
    runs-on: ubuntu-latest
    # ç­‰å¾… Core æ¨¡å—å‘å¸ƒå®Œæˆ
    needs: [publish-core]

    steps:
      # ----------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # Step 2: è®¾ç½® JDK 17 ç¯å¢ƒ
      # ----------------------------------------------------------------------
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      # ----------------------------------------------------------------------
      # Step 3: ç¼“å­˜ Maven ä¾èµ–
      # ----------------------------------------------------------------------
      - name: ğŸ“ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-boot3-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-boot3-
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # Step 4: ç‰ˆæœ¬å¤„ç†
      # ----------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Release Version: $VERSION"

      - name: ğŸ“ Update Version in pom.xml
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.VERSION }} -DgenerateBackupPoms=false -DprocessAllModules=true
          echo "âœ… All modules version updated to ${{ steps.version.outputs.VERSION }}"

      # ----------------------------------------------------------------------
      # Step 5: æ„å»ºå¹¶å‘å¸ƒåˆ° Maven ä¸­å¤®ä»“åº“
      # ----------------------------------------------------------------------
      - name: ğŸš€ Build and Publish Spring Boot 3.x to Maven Central
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} clean deploy \
            -pl json-view-ext-spring-boot3-starter-jakarta \
            -Prelease \
            -DskipTests=true \
            -Dgpg.passphrase=${{ secrets.MAVEN_GPG_PASSPHRASE }}
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      # ----------------------------------------------------------------------
      # Step 6: ä¸Šä¼ æ„å»ºäº§ç‰©
      # ----------------------------------------------------------------------
      - name: ğŸ“¤ Upload Spring Boot 3.x Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot3-artifacts
          path: |
            json-view-ext-spring-boot3-starter-jakarta/target/*.jar
          retention-days: 5

  # ==========================================================================
  # Job 4: åˆ›å»º GitHub Release å¹¶ç”Ÿæˆå˜æ›´æ—¥å¿—
  # ==========================================================================
  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    # ç­‰å¾…æ‰€æœ‰å‘å¸ƒ job å®Œæˆåå†åˆ›å»º Release
    needs: [publish-core, publish-spring-boot, publish-spring-boot3]

    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

    steps:
      # ----------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥ç”Ÿæˆå˜æ›´æ—¥å¿—

      # ----------------------------------------------------------------------
      # Step 2: æå–ç‰ˆæœ¬ä¿¡æ¯
      # ----------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract Version Info
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆåŒ…å« alphaã€betaã€rc ç­‰ï¼‰
          if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]] || [[ "$VERSION" == *"SNAPSHOT"* ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------------
      # Step 3: ç”Ÿæˆå˜æ›´æ—¥å¿—
      # ----------------------------------------------------------------------
      - name: ğŸ“‹ Generate Changelog
        id: changelog
        run: |
          echo "ğŸ“ Generating changelog..."
          
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${{ github.ref_name }}
          
          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: $CURRENT_TAG"
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—å†…å®¹
          {
            echo "## ğŸ¯ What's Changed"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
              echo "### ğŸ“ Commits"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges | head -50
              echo ""
              echo ""
          
              # è·å–è´¡çŒ®è€…åˆ—è¡¨
              echo "### ğŸ‘¥ Contributors"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"@%an" --no-merges | sort -u | sed 's/^/- /'
            else
              echo "ğŸ‰ Initial Release"
              echo ""
              git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges | head -30
            fi
          
            echo ""
            echo ""
            echo "---"
            echo ""
            echo "## ğŸ“¦ Maven Coordinates"
            echo ""
            echo "### Core Module (JDK 8+)"
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-core</artifactId>"
            echo "    <version>${{ steps.version.outputs.VERSION }}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
            echo "### Spring Boot 1.x / Spring Boot 2.x (JDK 8+)"
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot-starter</artifactId>"
            echo "    <version>${{ steps.version.outputs.VERSION }}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
            echo "### Spring Boot 3.x (JDK 17+)"
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot3-starter</artifactId>"
            echo "    <version>${{ steps.version.outputs.VERSION }}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
            echo "---"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
          } > CHANGELOG.md
          
          echo "changelog_file=CHANGELOG.md" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------------
      # Step 4: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      # ----------------------------------------------------------------------
      - name: ğŸ“¥ Download Core Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-artifacts
          path: artifacts/core

      - name: ğŸ“¥ Download Spring Boot 1.x / Spring Boot 2.x Artifacts
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-artifacts
          path: artifacts/spring-boot

      - name: ğŸ“¥ Download Spring Boot 3.x Artifacts
        uses: actions/download-artifact@v4
        with:
          name: spring-boot3-artifacts
          path: artifacts/spring-boot3

      # ----------------------------------------------------------------------
      # Step 5: åˆ›å»º GitHub Release
      # ----------------------------------------------------------------------
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: "Release ${{ steps.version.outputs.TAG_NAME }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ steps.version.outputs.PRERELEASE }}
          files: |
            artifacts/core/*.jar
            artifacts/spring-boot/*.jar
            artifacts/spring-boot3/*.jar
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------------
      # Step 6: å‘å¸ƒæˆåŠŸé€šçŸ¥
      # ----------------------------------------------------------------------
      - name: âœ… Release Summary
        run: |
          echo "=============================================="
          echo "ğŸ‰ Release ${{ steps.version.outputs.TAG_NAME }} Published Successfully!"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Published Modules:"
          echo "  - json-view-ext-core (JDK 8)"
          echo "  - json-view-ext-spring-boot-starter-javax (JDK 8)"
          echo "  - json-view-ext-spring-boot3-starter-jakarta (JDK 17)"
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG_NAME }}"
          echo "ğŸ”— Maven Central: https://search.maven.org/search?q=g:io.github.vennarshulytz"
          echo ""
          echo "=============================================="