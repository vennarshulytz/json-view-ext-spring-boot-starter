name: Release and Publish to Maven Central

# =============================================================================
# è§¦å‘æ¡ä»¶
# =============================================================================
on:
  # æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'  # åŒ¹é…: v1.0.0, v2.1.0, v1.0.0-beta, v1.0.0-RC1 ç­‰

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºè°ƒè¯•ã€é‡æ–°å‘å¸ƒæˆ–ç´§æ€¥ä¿®å¤ï¼‰
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦å‘å¸ƒçš„æ ‡ç­¾åç§°ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: true
        type: string
      skip_tests:
        description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ï¼ˆä¸å®é™…å‘å¸ƒï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# =============================================================================
# å…¨å±€ç¯å¢ƒå˜é‡
# =============================================================================
env:
  # Maven JVM å‚æ•°ä¼˜åŒ–ï¼šå¢åŠ å†…å­˜é™åˆ¶ï¼Œå‡å°‘æ—¥å¿—å™ªéŸ³
  MAVEN_OPTS: >-
    -Xmx1024m 
    -XX:MaxMetaspaceSize=512m 
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
    -Dorg.slf4j.simpleLogger.showDateTime=true
    -Djava.awt.headless=true

  # Maven CLI é€šç”¨å‚æ•°ï¼šæ‰¹å¤„ç†æ¨¡å¼ï¼Œæ˜¾ç¤ºé”™è¯¯å’Œç‰ˆæœ¬ä¿¡æ¯
  MAVEN_CLI_OPTS: '--batch-mode --errors --fail-at-end --show-version --no-transfer-progress'

# =============================================================================
# å¹¶å‘æ§åˆ¶
# =============================================================================
# åŒä¸€ refï¼ˆæ ‡ç­¾ï¼‰åªå…è®¸ä¸€ä¸ªå‘å¸ƒæµç¨‹è¿è¡Œï¼Œé¿å…é‡å¤å‘å¸ƒ
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„å‘å¸ƒï¼Œç¡®ä¿å®Œæ•´æ€§

# =============================================================================
# ä½œä¸šå®šä¹‰
# =============================================================================
jobs:
  # ===========================================================================
  # Job 1: éªŒè¯ä¸å‡†å¤‡
  # ===========================================================================
  # éªŒè¯æ ‡ç­¾æ ¼å¼ï¼Œæå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¸ºåç»­ä½œä¸šå‡†å¤‡æ•°æ®
  # ===========================================================================
  prepare:
    name: ğŸ” Validate & Prepare
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      tag_name: ${{ steps.extract-version.outputs.tag_name }}
      is_prerelease: ${{ steps.extract-version.outputs.is_prerelease }}
      skip_tests: ${{ steps.set-options.outputs.skip_tests }}
      dry_run: ${{ steps.set-options.outputs.dry_run }}

    steps:
      # ------------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç ï¼ˆæµ…å…‹éš†ï¼Œä»…ç”¨äºéªŒè¯ï¼‰
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ------------------------------------------------------------------------
      # Step 2: è®¾ç½®è¿è¡Œé€‰é¡¹
      # ------------------------------------------------------------------------
      - name: âš™ï¸ Set Runtime Options
        id: set-options
        run: |
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "skip_tests=${{ github.event.inputs.skip_tests }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            # è‡ªåŠ¨è§¦å‘æ—¶é»˜è®¤è·³è¿‡æµ‹è¯•ï¼ˆå‡è®¾å‘å¸ƒå‰å·²å®Œæˆæµ‹è¯•ï¼‰
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------------------------
      # Step 3: æå–å¹¶éªŒè¯ç‰ˆæœ¬ä¿¡æ¯
      # ------------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract Version from Tag
        id: extract-version
        run: |
          # ç¡®å®šæ ‡ç­¾åç§°ï¼ˆæ”¯æŒæ‰‹åŠ¨è§¦å‘æ—¶æŒ‡å®šï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          
          echo "ğŸ“Œ Processing tag: $TAG_NAME"
          
          # éªŒè¯æ ‡ç­¾æ ¼å¼
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "   Expected format: v<major>.<minor>.<patch>[-<prerelease>]"
            echo "   Examples: v1.0.0, v2.1.0-beta, v1.0.0-RC1"
            exit 1
          fi
          
          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ 'v' å‰ç¼€ï¼‰
          VERSION="${TAG_NAME#v}"
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$VERSION" =~ (alpha|beta|rc|snapshot|SNAPSHOT|RC|Alpha|Beta) ]]; then
            IS_PRERELEASE="true"
            echo "âš ï¸  Pre-release version detected"
          else
            IS_PRERELEASE="false"
            echo "âœ… Stable release version"
          fi
          
          # è¾“å‡ºç»“æœ
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       Version Information              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Tag:        $TAG_NAME"
          echo "â•‘  Version:    $VERSION"
          echo "â•‘  Prerelease: $IS_PRERELEASE"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ------------------------------------------------------------------------
      # Step 4: éªŒè¯ POM ç‰ˆæœ¬ä¸€è‡´æ€§
      # ------------------------------------------------------------------------
      - name: ğŸ” Validate POM Version
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          POM_VERSION=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | tr -d '[:space:]')
          
          echo "ğŸ“‹ Tag version:  $VERSION"
          echo "ğŸ“‹ POM version:  $POM_VERSION"
          
          if [ "$VERSION" != "$POM_VERSION" ]; then
            echo ""
            echo "âš ï¸  WARNING: Version mismatch detected!"
            echo "   Tag version ($VERSION) differs from POM version ($POM_VERSION)"
            echo "   Please ensure versions are synchronized before release."
            echo ""
            # åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ å¯èƒ½æƒ³è¦è®©è¿™ä¸ªæ£€æŸ¥å¤±è´¥
            # exit 1
          else
            echo "âœ… Versions are synchronized"
          fi

  # ===========================================================================
  # Job 2: å‘å¸ƒåˆ° Maven Central
  # ===========================================================================
  # ä½¿ç”¨ JDK 17 æ„å»ºå’Œå‘å¸ƒæ‰€æœ‰æ¨¡å—ï¼ˆå…¼å®¹ JDK 8 å’Œ JDK 17 æ¨¡å—ï¼‰
  # ===========================================================================
  publish:
    name: ğŸ“¦ Publish to Maven Central
    runs-on: ubuntu-latest
    needs: [prepare]
    
    # ä»…åœ¨éè¯•è¿è¡Œæ¨¡å¼ä¸‹æ‰§è¡Œ
    if: needs.prepare.outputs.dry_run != 'true'

    steps:
      # ------------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç ï¼ˆå®Œæ•´å†å²ï¼Œç”¨äºç‰ˆæœ¬ä¿¡æ¯ï¼‰
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag_name }}
          fetch-depth: 0

      # ------------------------------------------------------------------------
      # Step 2: è®¾ç½® JDK 17 ç¯å¢ƒ
      # ------------------------------------------------------------------------
      # ä½¿ç”¨ JDK 17 ä»¥æ”¯æŒ Spring Boot 3.x æ¨¡å—ç¼–è¯‘
      # Maven çš„ source/target é…ç½®ç¡®ä¿ JDK 8 æ¨¡å—çš„å…¼å®¹æ€§
      # ------------------------------------------------------------------------
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          # Maven Central è®¤è¯é…ç½®
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          # GPG ç­¾åé…ç½®
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      # ------------------------------------------------------------------------
      # Step 3: é…ç½® GPG ä»£ç†
      # ------------------------------------------------------------------------
      # åœ¨ CI ç¯å¢ƒä¸­ï¼ŒGPG éœ€è¦ä½¿ç”¨ loopback æ¨¡å¼è¿›è¡Œéäº¤äº’å¼ç­¾å
      # ------------------------------------------------------------------------
      - name: ğŸ” Configure GPG Agent
        run: |
          echo "ğŸ” Configuring GPG for non-interactive signing..."
          
          # åˆ›å»º GPG é…ç½®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          
          # é…ç½® GPG ä»£ç†ä½¿ç”¨ loopback pinentry
          cat > ~/.gnupg/gpg-agent.conf << EOF
          allow-loopback-pinentry
          allow-preset-passphrase
          default-cache-ttl 600
          max-cache-ttl 7200
          EOF
          
          # é…ç½® GPG ä½¿ç”¨ä»£ç†å’Œ loopback æ¨¡å¼
          cat > ~/.gnupg/gpg.conf << EOF
          use-agent
          pinentry-mode loopback
          no-tty
          EOF
          
          # é‡å¯ GPG ä»£ç†ä»¥åº”ç”¨æ–°é…ç½®
          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent || true
          
          # éªŒè¯ GPG å¯†é’¥å·²å¯¼å…¥
          echo "ğŸ“‹ Available GPG keys:"
          gpg --list-secret-keys --keyid-format LONG || echo "   No keys found"
          
          echo "âœ… GPG configuration completed"

      # ------------------------------------------------------------------------
      # Step 4: éªŒè¯ Maven ç¯å¢ƒ
      # ------------------------------------------------------------------------
      - name: ğŸ”§ Verify Maven Environment
        run: |
          echo "ğŸ“‹ Maven version:"
          mvn --version
          echo ""
          echo "ğŸ“‹ Java version:"
          java --version
          echo ""
          echo "ğŸ“‹ Environment variables:"
          echo "   JAVA_HOME: $JAVA_HOME"
          echo "   MAVEN_OPTS: $MAVEN_OPTS"

      # ------------------------------------------------------------------------
      # Step 5: æ„å»ºå¹¶å‘å¸ƒåˆ° Maven Central
      # ------------------------------------------------------------------------
      # æ³¨æ„ï¼šcentral-publishing-maven-plugin ä¼šè‡ªåŠ¨å¤„ç†ä¾èµ–é¡ºåº
      # æ‰€æœ‰æ¨¡å—ä¼šå…ˆä¸Šä¼ åˆ°æš‚å­˜åŒºï¼Œç„¶åä¸€èµ·å‘å¸ƒ
      # ------------------------------------------------------------------------
      - name: ğŸš€ Build and Publish
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   Publishing to Maven Central"
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          echo "   Skip Tests: ${{ needs.prepare.outputs.skip_tests }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ„å»ºå‚æ•°
          MAVEN_ARGS="${MAVEN_CLI_OPTS}"
          MAVEN_ARGS="${MAVEN_ARGS} -P release"
          
          # æ˜¯å¦è·³è¿‡æµ‹è¯•
          if [ "${{ needs.prepare.outputs.skip_tests }}" = "true" ]; then
            MAVEN_ARGS="${MAVEN_ARGS} -DskipTests"
            echo "â­ï¸  Tests will be skipped"
          fi
          
          echo ""
          echo "ğŸ“¦ Starting Maven deploy..."
          echo "   Command: mvn clean deploy ${MAVEN_ARGS}"
          echo ""
          
          # æ‰§è¡Œå‘å¸ƒ
          # ä½¿ç”¨ -e æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
          mvn clean deploy ${MAVEN_ARGS} -e \
            -Dgpg.passphrase="${MAVEN_GPG_PASSPHRASE}"
          
          echo ""
          echo "âœ… Successfully published to Maven Central!"
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      # ------------------------------------------------------------------------
      # Step 6: å‘å¸ƒåéªŒè¯
      # ------------------------------------------------------------------------
      - name: âœ… Post-Publish Verification
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ“¦ Publish Completed Successfully!                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                â•‘"
          echo "â•‘  Published artifacts:                                          â•‘"
          echo "â•‘    â€¢ json-view-ext-parent:${VERSION}                            "
          echo "â•‘    â€¢ json-view-ext-core:${VERSION}                              "
          echo "â•‘    â€¢ json-view-ext-spring-boot-starter:${VERSION}               "
          echo "â•‘    â€¢ json-view-ext-spring-boot3-starter:${VERSION}              "
          echo "â•‘                                                                â•‘"
          echo "â•‘  Note: Artifacts may take 10-30 minutes to appear on           â•‘"
          echo "â•‘        Maven Central search.                                   â•‘"
          echo "â•‘                                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ===========================================================================
  # Job 3: åˆ›å»º GitHub Release
  # ===========================================================================
  # ç­‰å¾…å‘å¸ƒå®Œæˆåï¼Œåˆ›å»º GitHub Release å¹¶ç”Ÿæˆå˜æ›´æ—¥å¿—
  # ===========================================================================
  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, publish]
    
    # å³ä½¿ publish è¢«è·³è¿‡ï¼ˆè¯•è¿è¡Œæ¨¡å¼ï¼‰ï¼Œä¹Ÿå¯ä»¥åˆ›å»º release
    if: always() && needs.prepare.result == 'success' && (needs.publish.result == 'success' || needs.publish.result == 'skipped')

    permissions:
      contents: write  # åˆ›å»º Release éœ€è¦å†™æƒé™

    steps:
      # ------------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag_name }}
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥ç”Ÿæˆå˜æ›´æ—¥å¿—

      # ------------------------------------------------------------------------
      # Step 2: ç”Ÿæˆå˜æ›´æ—¥å¿—
      # ------------------------------------------------------------------------
      - name: ğŸ“‹ Generate Changelog
        id: changelog
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CURRENT_TAG="${{ needs.prepare.outputs.tag_name }}"
          
          echo "ğŸ“ Generating changelog for $CURRENT_TAG..."
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          
          echo "   Current tag:  $CURRENT_TAG"
          echo "   Previous tag: ${PREVIOUS_TAG:-'(initial release)'}"
          echo ""
          
          # åˆ›å»ºå˜æ›´æ—¥å¿—
          {
            echo "## ğŸ¯ What's Changed in ${CURRENT_TAG}"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              # ==============================================================
              # æœ‰ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼šç”Ÿæˆå·®å¼‚æ—¥å¿—
              # ==============================================================
          
              # ç»Ÿè®¡æäº¤æ•°é‡
              COMMIT_COUNT=$(git rev-list --count ${PREVIOUS_TAG}..${CURRENT_TAG})
              echo "ğŸ“Š **${COMMIT_COUNT} commits** since ${PREVIOUS_TAG}"
              echo ""
          
              # æ–°ç‰¹æ€§
              echo "### âœ¨ New Features"
              echo ""
              FEATURES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^feat" --grep="^feature" --grep="^add" -i 2>/dev/null | head -15)
              if [ -n "$FEATURES" ]; then
                echo "$FEATURES"
              else
                echo "_No new features in this release_"
              fi
              echo ""
          
              # Bug ä¿®å¤
              echo "### ğŸ› Bug Fixes"
              echo ""
              FIXES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^fix" --grep="^bug" --grep="^hotfix" -i 2>/dev/null | head -15)
              if [ -n "$FIXES" ]; then
                echo "$FIXES"
              else
                echo "_No bug fixes in this release_"
              fi
              echo ""
          
              # æ–‡æ¡£æ›´æ–°
              echo "### ğŸ“š Documentation"
              echo ""
              DOCS=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^doc" --grep="^docs" -i 2>/dev/null | head -10)
              if [ -n "$DOCS" ]; then
                echo "$DOCS"
              else
                echo "_No documentation changes_"
              fi
              echo ""
          
              # å…¶ä»–å˜æ›´
              echo "### ğŸ”§ Other Changes"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges 2>/dev/null | \
                grep -v -i "^- feat" | grep -v -i "^- fix" | grep -v -i "^- doc" | grep -v -i "^- add" | grep -v -i "^- bug" | head -10 || echo "_No other changes_"
              echo ""
          
            else
              # ==============================================================
              # åˆå§‹ç‰ˆæœ¬
              # ==============================================================
              echo "ğŸ‰ **Initial Release!**"
              echo ""
              echo "This is the first release of JSON View Extension."
              echo ""
              echo "### ğŸ“ Initial Commits"
              echo ""
              git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges 2>/dev/null | head -20
              echo ""
            fi
          
            echo ""
            echo "---"
            echo ""
          
            # ==============================================================
            # Maven ä¾èµ–ä¿¡æ¯
            # ==============================================================
            echo "## ğŸ“¦ Installation"
            echo ""
            echo "Add the following dependency to your \`pom.xml\`:"
            echo ""
          
            echo "### Core Module (JDK 8+)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-core</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "### Spring Boot 1.x / 2.x (JDK 8+, javax)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot-starter</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "### Spring Boot 3.x (JDK 17+, jakarta)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot3-starter</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "---"
            echo ""
          
            # ==============================================================
            # ç›¸å…³é“¾æ¥
            # ==============================================================
            echo "## ğŸ”— Links"
            echo ""
            echo "- ğŸ“– [Documentation](https://github.com/${{ github.repository }}#readme)"
            echo "- ğŸ” [Maven Central](https://search.maven.org/search?q=g:io.github.vennarshulytz%20AND%20a:json-view-ext*)"
            echo "- ğŸ› [Report Issues](https://github.com/${{ github.repository }}/issues)"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
            fi
          
          } > CHANGELOG.md
          
          echo "âœ… Changelog generated successfully"
          echo ""
          echo "--- Generated Changelog Preview ---"
          head -50 CHANGELOG.md
          echo "..."

      # ------------------------------------------------------------------------
      # Step 3: åˆ›å»º GitHub Release
      # ------------------------------------------------------------------------
      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: "ğŸš€ Release ${{ needs.prepare.outputs.tag_name }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------------
      # Step 4: å‘å¸ƒæˆåŠŸæ‘˜è¦
      # ------------------------------------------------------------------------
      - name: ğŸ“Š Release Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ‰ GitHub Release Created Successfully!                          â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ“Œ Version:     ${{ needs.prepare.outputs.version }}                              "
          echo "â•‘   ğŸ·ï¸  Tag:         ${{ needs.prepare.outputs.tag_name }}                              "
          echo "â•‘   ğŸ“‹ Prerelease:  ${{ needs.prepare.outputs.is_prerelease }}                              "
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ”— Release URL:                                                  â•‘"
          echo "â•‘      https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag_name }}"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ===========================================================================
  # Job 4: å‘å¸ƒå¤±è´¥é€šçŸ¥
  # ===========================================================================
  # å½“ä»»ä½•å…³é”®ä½œä¸šå¤±è´¥æ—¶è§¦å‘ï¼Œæä¾›è¯Šæ–­ä¿¡æ¯
  # ===========================================================================
  notify-failure:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [prepare, publish, create-release]
    if: failure()

    steps:
      - name: ğŸš¨ Generate Failure Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   âŒ Release Workflow Failed                                       â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   Job Status:                                                      â•‘"
          echo "â•‘     â€¢ prepare:        ${{ needs.prepare.result }}                              "
          echo "â•‘     â€¢ publish:        ${{ needs.publish.result }}                              "
          echo "â•‘     â€¢ create-release: ${{ needs.create-release.result }}                              "
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ” Common Issues & Solutions:                                    â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   1. GPG Signing Failed                                            â•‘"
          echo "â•‘      â€¢ Check MAVEN_GPG_PRIVATE_KEY secret format                   â•‘"
          echo "â•‘      â€¢ Verify MAVEN_GPG_PASSPHRASE is correct                      â•‘"
          echo "â•‘      â€¢ Ensure GPG key is not expired                               â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   2. Maven Central Authentication Failed                           â•‘"
          echo "â•‘      â€¢ Verify OSSRH_USERNAME and OSSRH_TOKEN secrets               â•‘"
          echo "â•‘      â€¢ Check if token has publish permissions                      â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   3. Deployment Validation Failed                                  â•‘"
          echo "â•‘      â€¢ Ensure all required files (pom, sources, javadoc) exist     â•‘"
          echo "â•‘      â€¢ Check for duplicate version (already published)             â•‘"
          echo "â•‘      â€¢ Verify module dependencies are resolvable                   â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   4. Module Build Failed                                           â•‘"
          echo "â•‘      â€¢ Check if module directory names match pom.xml               â•‘"
          echo "â•‘      â€¢ Verify parent-child version consistency                     â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ“‹ Next Steps:                                                   â•‘"
          echo "â•‘     1. Review the workflow logs above for detailed errors          â•‘"
          echo "â•‘     2. Fix the identified issues                                   â•‘"
          echo "â•‘     3. Delete the failed tag: git tag -d <tag> && git push -d ...  â•‘"
          echo "â•‘     4. Create a new tag and push to trigger release                â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          exit 1

  # ===========================================================================
  # Job 5: å‘å¸ƒæˆåŠŸé€šçŸ¥
  # ===========================================================================
  # æ‰€æœ‰ä½œä¸šæˆåŠŸå®Œæˆåï¼Œè¾“å‡ºæœ€ç»ˆæ‘˜è¦
  # ===========================================================================
  notify-success:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: [prepare, publish, create-release]
    if: success()

    steps:
      - name: âœ… Generate Success Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ‰ Release ${{ needs.prepare.outputs.tag_name }} Completed Successfully!        â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ“¦ Published Modules:                                            â•‘"
          echo "â•‘      â”œâ”€â”€ json-view-ext-parent                                      â•‘"
          echo "â•‘      â”œâ”€â”€ json-view-ext-core (JDK 8+)                               â•‘"
          echo "â•‘      â”œâ”€â”€ json-view-ext-spring-boot-starter (JDK 8+ / javax)        â•‘"
          echo "â•‘      â””â”€â”€ json-view-ext-spring-boot3-starter (JDK 17+ / jakarta)    â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ”— Resources:                                                    â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   â€¢ GitHub Release:                                                â•‘"
          echo "â•‘     https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag_name }}"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   â€¢ Maven Central (may take 10-30 min to sync):                    â•‘"
          echo "â•‘     https://search.maven.org/search?q=g:io.github.vennarshulytz    â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   â€¢ Repository:                                                    â•‘"
          echo "â•‘     https://repo1.maven.org/maven2/io/github/vennarshulytz/        â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""