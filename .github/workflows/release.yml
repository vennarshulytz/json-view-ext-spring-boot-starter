name: Release and Publish to Maven Central

# =============================================================================
# è§¦å‘æ¡ä»¶
# =============================================================================
on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v2.1.0-beta
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•æˆ–é‡æ–°å‘å¸ƒï¼‰
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# =============================================================================
# å…¨å±€ç¯å¢ƒå˜é‡
# =============================================================================
env:
  # Maven JVM å‚æ•°ä¼˜åŒ–
  MAVEN_OPTS: "-Xmx1024m -XX:MaxMetaspaceSize=512m -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn"
  # Maven CLI é€šç”¨å‚æ•°
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version --no-transfer-progress"
  # æ˜¯å¦è·³è¿‡æµ‹è¯•ï¼ˆé»˜è®¤è·³è¿‡ï¼Œå› ä¸ºå‘å¸ƒå‰åº”å·²å®Œæˆæµ‹è¯•ï¼‰
  SKIP_TESTS: ${{ github.event.inputs.skip_tests || 'true' }}

# =============================================================================
# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªå‘å¸ƒæµç¨‹è¿è¡Œ
# =============================================================================
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Job 1: å‘å¸ƒåˆ° Maven ä¸­å¤®ä»“åº“
  # ===========================================================================
  # ä½¿ç”¨ JDK 17 æ„å»ºï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
  # ===========================================================================
  publish-parent:
    name: ğŸ“¦ Publish
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      tag_name: ${{ steps.version.outputs.TAG_NAME }}
      prerelease: ${{ steps.version.outputs.PRERELEASE }}

    steps:
      # ------------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      # ------------------------------------------------------------------------
      # Step 2: è®¾ç½® JDK 17 ç¯å¢ƒ
      # ------------------------------------------------------------------------
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      # ------------------------------------------------------------------------
      # Step 3: é…ç½® GPG
      # ------------------------------------------------------------------------
      - name: Configure GPG for loopback mode
        run: |
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          gpgconf --kill gpg-agent    

      # Step 4: ä» tag ä¸­æå–ç‰ˆæœ¬å·
      # ------------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          # ä» tag åç§°ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ 'v' å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Release Version: $VERSION"
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$VERSION" =~ (alpha|beta|rc|SNAPSHOT|snapshot) ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ This is a pre-release version"
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "âœ… This is a stable release"
          fi

      # ------------------------------------------------------------------------
      # Step 5: å‘å¸ƒåˆ° Maven ä¸­å¤®ä»“åº“
      # ------------------------------------------------------------------------
      - name: ğŸš€ Publish to Maven Central
        run: |
          echo "ğŸ“¤ Publishing to Maven Central..."
          mvn -B clean deploy -P release -DskipTests
          echo "âœ… Parent POM published successfully"
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

  # ===========================================================================
  # Job 2: åˆ›å»º GitHub Release å¹¶ç”Ÿæˆå˜æ›´æ—¥å¿—
  # ===========================================================================
  # ç­‰å¾…æ‰€æœ‰æ¨¡å—å‘å¸ƒå®Œæˆåæ‰§è¡Œ
  # ===========================================================================
  create-github-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest

    permissions:
      contents: write  # åˆ›å»º Release éœ€è¦å†™æƒé™

    steps:
      # ------------------------------------------------------------------------
      # Step 1: æ£€å‡ºä»£ç 
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥ç”Ÿæˆå˜æ›´æ—¥å¿—

      # ------------------------------------------------------------------------
      # Step 2: ç”Ÿæˆå˜æ›´æ—¥å¿—
      # ------------------------------------------------------------------------
      - name: ğŸ“‹ Generate Changelog
        id: changelog
        run: |
          echo "ğŸ“ Generating changelog..."
          
          VERSION="${{ needs.publish-parent.outputs.version }}"
          CURRENT_TAG="${{ needs.publish-parent.outputs.tag_name }}"
          
          # å°è¯•è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "ğŸ“Œ Current tag: $CURRENT_TAG"
          echo "ğŸ“Œ Previous tag: ${PREVIOUS_TAG:-'(none - initial release)'}"
          
          # åˆ›å»ºå˜æ›´æ—¥å¿—æ–‡ä»¶
          {
            echo "## ğŸ¯ What's Changed in $CURRENT_TAG"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              # ----------------------------------------------------------------
              # æœ‰ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç”Ÿæˆå·®å¼‚æ—¥å¿—
              # ----------------------------------------------------------------
          
              # ç‰¹æ€§å’Œæ”¹è¿›
              echo "### âœ¨ Features & Improvements"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^feat" --grep="^add" --grep="^improve" -i | head -20 || echo "- No new features in this release"
              echo ""
              echo ""
          
              # Bug ä¿®å¤
              echo "### ğŸ› Bug Fixes"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^fix" --grep="^bug" -i | head -20 || echo "- No bug fixes in this release"
              echo ""
              echo ""
          
              # å…¶ä»–å˜æ›´
              echo "### ğŸ“ Other Changes"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges | grep -v -i "^- feat" | grep -v -i "^- fix" | grep -v -i "^- add" | head -15 || echo "- Miscellaneous improvements"
              echo ""
              echo ""
          
              # è´¡çŒ®è€…
              echo "### ğŸ‘¥ Contributors"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"%an" --no-merges | sort -u | while read name; do
                echo "- $name"
              done
              echo ""
          
            else
              # ----------------------------------------------------------------
              # åˆå§‹ç‰ˆæœ¬
              # ----------------------------------------------------------------
              echo "ğŸ‰ **Initial Release**"
              echo ""
              echo "This is the first release of JSON View Extension!"
              echo ""
              echo "### ğŸ“ All Commits"
              echo ""
              git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges | head -30
              echo ""
            fi
          
            echo ""
            echo "---"
            echo ""
          
            # ==================================================================
            # Maven åæ ‡ä¿¡æ¯
            # ==================================================================
            echo "## ğŸ“¦ Maven Coordinates"
            echo ""
            echo "Add the following dependencies to your \`pom.xml\`:"
            echo ""
          
            echo "### Core Module (JDK 8+)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-core</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "### Spring Boot 1.x / 2.x Starter (JDK 8+, javax)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot-starter</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "### Spring Boot 3.x Starter (JDK 17+, jakarta)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot3-starter</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "---"
            echo ""
            echo "## ğŸ”— Links"
            echo ""
            echo "- ğŸ“– [Documentation](https://github.com/${{ github.repository }}#readme)"
            echo "- ğŸ” [Maven Central Search](https://search.maven.org/search?q=g:io.github.vennarshulytz)"
            echo "- ğŸ› [Report Issues](https://github.com/${{ github.repository }}/issues)"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
            fi
          
          } > CHANGELOG.md
          
          echo "âœ… Changelog generated successfully"
          cat CHANGELOG.md

      # ------------------------------------------------------------------------
      # Step 3: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      # ------------------------------------------------------------------------
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      # ------------------------------------------------------------------------
      # Step 4: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      # ------------------------------------------------------------------------
      - name: ğŸ“ Prepare Release Assets
        run: |
          echo "ğŸ“ Preparing release assets..."
          mkdir -p release-assets
          
          # å¤åˆ¶æ‰€æœ‰ jar æ–‡ä»¶åˆ° release-assets ç›®å½•
          find artifacts -name "*.jar" -type f | while read jar; do
            cp "$jar" release-assets/
            echo "  - $(basename $jar)"
          done
          
          echo "âœ… Release assets prepared"
          ls -la release-assets/

      # ------------------------------------------------------------------------
      # Step 5: åˆ›å»º GitHub Release
      # ------------------------------------------------------------------------
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.publish-parent.outputs.tag_name }}
          name: "ğŸš€ Release ${{ needs.publish-parent.outputs.tag_name }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.publish-parent.outputs.prerelease == 'true' }}
          files: release-assets/*.jar
          fail_on_unmatched_files: false
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------------
      # Step 6: å‘å¸ƒæˆåŠŸæ‘˜è¦
      # ------------------------------------------------------------------------
      - name: âœ… Release Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                  â•‘"
          echo "â•‘   ğŸ‰ Release ${{ needs.publish-parent.outputs.tag_name }} Published Successfully!          â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                  â•‘"
          echo "â•‘   ğŸ“¦ Published Modules:                                          â•‘"
          echo "â•‘      â”œâ”€â”€ json-view-ext-parent (Parent POM)                       â•‘"
          echo "â•‘      â”œâ”€â”€ json-view-ext-core (JDK 8+)                             â•‘"
          echo "â•‘      â”œâ”€â”€ json-view-ext-spring-boot-starter-javax (JDK 8+)        â•‘"
          echo "â•‘      â””â”€â”€ json-view-ext-spring-boot3-starter-jakarta (JDK 17+)    â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                  â•‘"
          echo "â•‘   ğŸ”— Useful Links:                                               â•‘"
          echo "â•‘      â€¢ GitHub Release:                                           â•‘"
          echo "â•‘        https://github.com/${{ github.repository }}/releases/tag/${{ needs.publish-parent.outputs.tag_name }}"
          echo "â•‘      â€¢ Maven Central:                                            â•‘"
          echo "â•‘        https://search.maven.org/search?q=g:io.github.vennarshulytz"
          echo "â•‘                                                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

  # ===========================================================================
  # Job 3: å‘å¸ƒå¤±è´¥æ—¶çš„æ¸…ç†å’Œé€šçŸ¥
  # ===========================================================================
  notify-on-failure:
    name: ğŸš¨ Notify on Failure
    runs-on: ubuntu-latest
    needs: [publish-parent, create-github-release]
    if: failure()

    steps:
      - name: ğŸš¨ Release Failed Notification
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                  â•‘"
          echo "â•‘   âŒ Release Failed!                                             â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘   Please check the workflow logs for details.                    â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘   Common issues:                                                 â•‘"
          echo "â•‘   1. GPG signing failed - check MAVEN_GPG_PRIVATE_KEY secret     â•‘"
          echo "â•‘   2. Maven Central auth failed - check OSSRH credentials         â•‘"
          echo "â•‘   3. Module dependency issue - check publish order               â•‘"
          echo "â•‘   4. Version conflict - ensure consistent versions               â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          exit 1