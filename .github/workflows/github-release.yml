name: Create GitHub Release

# =============================================================================
# è§¦å‘æ¡ä»¶
# =============================================================================
on:
#  # æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
#  push:
#    tags:
#      - 'v*'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦å‘å¸ƒçš„æ ‡ç­¾åç§°ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: true
        type: string
      skip_maven_check:
        description: 'è·³è¿‡ Maven Central å¯ç”¨æ€§æ£€æŸ¥'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# =============================================================================
# å¹¶å‘æ§åˆ¶
# =============================================================================
concurrency:
  group: github-release-${{ github.ref }}
  cancel-in-progress: false

# =============================================================================
# ä½œä¸šå®šä¹‰
# =============================================================================
jobs:
  # ===========================================================================
  # Job 1: éªŒè¯ä¸å‡†å¤‡
  # ===========================================================================
  prepare:
    name: ğŸ” Validate & Prepare
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      tag_name: ${{ steps.extract-version.outputs.tag_name }}
      is_prerelease: ${{ steps.extract-version.outputs.is_prerelease }}
      skip_maven_check: ${{ steps.set-options.outputs.skip_maven_check }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âš™ï¸ Set Runtime Options
        id: set-options
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "skip_maven_check=${{ github.event.inputs.skip_maven_check }}" >> $GITHUB_OUTPUT
          else
            echo "skip_maven_check=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Extract Version from Tag
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          
          echo "ğŸ“Œ Processing tag: $TAG_NAME"
          
          # éªŒè¯æ ‡ç­¾æ ¼å¼
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "   Expected format: v<major>.<minor>.<patch>[-<prerelease>]"
            exit 1
          fi
          
          VERSION="${TAG_NAME#v}"
          
          if [[ "$VERSION" =~ (alpha|beta|rc|snapshot|SNAPSHOT|RC|Alpha|Beta) ]]; then
            IS_PRERELEASE="true"
            echo "âš ï¸  Pre-release version detected"
          else
            IS_PRERELEASE="false"
            echo "âœ… Stable release version"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       Version Information              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Tag:        $TAG_NAME"
          echo "â•‘  Version:    $VERSION"
          echo "â•‘  Prerelease: $IS_PRERELEASE"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ===========================================================================
  # Job 2: å¯é€‰çš„ Maven Central æ£€æŸ¥
  # ===========================================================================
  check-maven:
    name: ğŸ” Check Maven Central (Optional)
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.skip_maven_check != 'true'
    continue-on-error: true  # å³ä½¿æ£€æŸ¥å¤±è´¥ä¹Ÿç»§ç»­

    outputs:
      maven_available: ${{ steps.check.outputs.available }}

    steps:
      - name: ğŸ” Check Maven Central Availability
        id: check
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          ARTIFACT="json-view-ext-core"
          GROUP_PATH="io/github/vennarshulytz"
          
          echo "ğŸ” Checking if version $VERSION is available on Maven Central..."
          echo ""
          
          # æ£€æŸ¥ Maven Central (å¯èƒ½éœ€è¦ç­‰å¾…åŒæ­¥)
          URL="https://repo1.maven.org/maven2/${GROUP_PATH}/${ARTIFACT}/${VERSION}/${ARTIFACT}-${VERSION}.pom"
          
          echo "   Checking: $URL"
          
          # æœ€å¤šç­‰å¾… 5 åˆ†é’Ÿ
          MAX_ATTEMPTS=10
          WAIT_SECONDS=30
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
          
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Artifact found on Maven Central!"
              echo "available=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          
            echo "   Attempt $i/$MAX_ATTEMPTS: HTTP $HTTP_CODE (waiting ${WAIT_SECONDS}s...)"
          
            if [ $i -lt $MAX_ATTEMPTS ]; then
              sleep $WAIT_SECONDS
            fi
          done
          
          echo ""
          echo "âš ï¸  Artifact not yet available on Maven Central"
          echo "   This is normal - it may take 10-30 minutes to sync"
          echo "available=false" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Job 3: åˆ›å»º GitHub Release
  # ===========================================================================
  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, check-maven]
    # å³ä½¿ maven check å¤±è´¥æˆ–è¢«è·³è¿‡ä¹Ÿæ‰§è¡Œ
    if: always() && needs.prepare.result == 'success'

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag_name }}
          fetch-depth: 0

      - name: ğŸ“‹ Generate Changelog
        id: changelog
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CURRENT_TAG="${{ needs.prepare.outputs.tag_name }}"
          
          echo "ğŸ“ Generating changelog for $CURRENT_TAG..."
          
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          
          echo "   Current tag:  $CURRENT_TAG"
          echo "   Previous tag: ${PREVIOUS_TAG:-'(initial release)'}"
          echo ""
          
          {
            echo "## ğŸ¯ What's Changed in ${CURRENT_TAG}"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              COMMIT_COUNT=$(git rev-list --count ${PREVIOUS_TAG}..${CURRENT_TAG})
              echo "ğŸ“Š **${COMMIT_COUNT} commits** since ${PREVIOUS_TAG}"
              echo ""
          
              echo "### âœ¨ New Features"
              echo ""
              FEATURES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^feat" --grep="^feature" --grep="^add" -i 2>/dev/null | head -15)
              if [ -n "$FEATURES" ]; then
                echo "$FEATURES"
              else
                echo "_No new features in this release_"
              fi
              echo ""
          
              echo "### ğŸ› Bug Fixes"
              echo ""
              FIXES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^fix" --grep="^bug" --grep="^hotfix" -i 2>/dev/null | head -15)
              if [ -n "$FIXES" ]; then
                echo "$FIXES"
              else
                echo "_No bug fixes in this release_"
              fi
              echo ""
          
              echo "### ğŸ“š Documentation"
              echo ""
              DOCS=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^doc" --grep="^docs" -i 2>/dev/null | head -10)
              if [ -n "$DOCS" ]; then
                echo "$DOCS"
              else
                echo "_No documentation changes_"
              fi
              echo ""
          
              echo "### ğŸ”§ Other Changes"
              echo ""
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges 2>/dev/null | \
                grep -v -i "^- feat" | grep -v -i "^- fix" | grep -v -i "^- doc" | grep -v -i "^- add" | grep -v -i "^- bug" | head -10 || echo "_No other changes_"
              echo ""
          
            else
              echo "ğŸ‰ **Initial Release!**"
              echo ""
              echo "This is the first release of JSON View Extension."
              echo ""
              echo "### ğŸ“ Initial Commits"
              echo ""
              git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges 2>/dev/null | head -20
              echo ""
            fi
          
            echo ""
            echo "---"
            echo ""
          
            echo "## ğŸ“¦ Installation"
            echo ""
            echo "Add the following dependency to your \`pom.xml\`:"
            echo ""
          
            echo "### Core Module (JDK 8+)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-core</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "### Spring Boot 1.x / 2.x (JDK 8+, javax)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot-starter</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "### Spring Boot 3.x (JDK 17+, jakarta)"
            echo ""
            echo '```xml'
            echo "<dependency>"
            echo "    <groupId>io.github.vennarshulytz</groupId>"
            echo "    <artifactId>json-view-ext-spring-boot3-starter</artifactId>"
            echo "    <version>${VERSION}</version>"
            echo "</dependency>"
            echo '```'
            echo ""
          
            echo "---"
            echo ""
          
            echo "## ğŸ”— Links"
            echo ""
            echo "- ğŸ“– [Documentation](https://github.com/${{ github.repository }}#readme)"
            echo "- ğŸ” [Maven Central](https://search.maven.org/search?q=g:io.github.vennarshulytz%20AND%20a:json-view-ext*)"
            echo "- ğŸ› [Report Issues](https://github.com/${{ github.repository }}/issues)"
            echo ""
          
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
            fi
          
          } > CHANGELOG.md
          
          echo "âœ… Changelog generated successfully"

      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: "ğŸš€ Release ${{ needs.prepare.outputs.tag_name }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Release Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ‰ GitHub Release Created Successfully!                          â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ“Œ Version:     ${{ needs.prepare.outputs.version }}                              "
          echo "â•‘   ğŸ·ï¸  Tag:         ${{ needs.prepare.outputs.tag_name }}                              "
          echo "â•‘   ğŸ“‹ Prerelease:  ${{ needs.prepare.outputs.is_prerelease }}                              "
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ”— Release URL:                                                  â•‘"
          echo "â•‘      https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag_name }}"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ===========================================================================
  # Job 4: å¤±è´¥é€šçŸ¥
  # ===========================================================================
  notify-failure:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: failure()

    steps:
      - name: ğŸš¨ Generate Failure Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âŒ GitHub Release Workflow Failed                                â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   Job Status:                                                      â•‘"
          echo "â•‘     â€¢ prepare:        ${{ needs.prepare.result }}                                 "
          echo "â•‘     â€¢ create-release: ${{ needs.create-release.result }}                                 "
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1