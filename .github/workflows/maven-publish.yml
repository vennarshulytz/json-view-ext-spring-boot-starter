name: Publish to Maven Central

# =============================================================================
# è§¦å‘æ¡ä»¶
# =============================================================================
on:
  # æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'  # åŒ¹é…: v1.0.0, v2.1.0, v1.0.0-beta, v1.0.0-RC1 ç­‰

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦å‘å¸ƒçš„æ ‡ç­¾åç§°ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: true
        type: string
      skip_tests:
        description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ï¼ˆä¸å®é™…å‘å¸ƒï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      deployment_timeout:
        description: 'éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        default: '30'
        type: choice
        options:
          - '15'
          - '30'
          - '45'
          - '60'

# =============================================================================
# å…¨å±€ç¯å¢ƒå˜é‡
# =============================================================================
env:
  MAVEN_OPTS: >-
    -Xmx1024m 
    -XX:MaxMetaspaceSize=512m 
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
    -Dorg.slf4j.simpleLogger.showDateTime=true
    -Djava.awt.headless=true

  MAVEN_CLI_OPTS: '--batch-mode --errors --fail-at-end --show-version --no-transfer-progress'

# =============================================================================
# å¹¶å‘æ§åˆ¶
# =============================================================================
concurrency:
  group: maven-publish-${{ github.ref }}
  cancel-in-progress: false

# =============================================================================
# ä½œä¸šå®šä¹‰
# =============================================================================
jobs:
  # ===========================================================================
  # Job 1: éªŒè¯ä¸å‡†å¤‡
  # ===========================================================================
  prepare:
    name: ğŸ” Validate & Prepare
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      tag_name: ${{ steps.extract-version.outputs.tag_name }}
      is_prerelease: ${{ steps.extract-version.outputs.is_prerelease }}
      skip_tests: ${{ steps.set-options.outputs.skip_tests }}
      dry_run: ${{ steps.set-options.outputs.dry_run }}
      deployment_timeout: ${{ steps.set-options.outputs.deployment_timeout }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âš™ï¸ Set Runtime Options
        id: set-options
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "skip_tests=${{ github.event.inputs.skip_tests }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
            echo "deployment_timeout=${{ github.event.inputs.deployment_timeout }}" >> $GITHUB_OUTPUT
          else
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
            echo "deployment_timeout=30" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Extract Version from Tag
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          
          echo "ğŸ“Œ Processing tag: $TAG_NAME"
          
          # éªŒè¯æ ‡ç­¾æ ¼å¼
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "   Expected format: v<major>.<minor>.<patch>[-<prerelease>]"
            echo "   Examples: v1.0.0, v2.1.0-beta, v1.0.0-RC1"
            exit 1
          fi
          
          VERSION="${TAG_NAME#v}"
          
          if [[ "$VERSION" =~ (alpha|beta|rc|snapshot|SNAPSHOT|RC|Alpha|Beta) ]]; then
            IS_PRERELEASE="true"
            echo "âš ï¸  Pre-release version detected"
          else
            IS_PRERELEASE="false"
            echo "âœ… Stable release version"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       Version Information              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Tag:        $TAG_NAME"
          echo "â•‘  Version:    $VERSION"
          echo "â•‘  Prerelease: $IS_PRERELEASE"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ” Validate POM Version
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          POM_VERSION=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | tr -d '[:space:]')
          
          echo "ğŸ“‹ Tag version:  $VERSION"
          echo "ğŸ“‹ POM version:  $POM_VERSION"
          
          if [ "$VERSION" != "$POM_VERSION" ]; then
            echo ""
            echo "âš ï¸  WARNING: Version mismatch detected!"
            echo "   Tag version ($VERSION) differs from POM version ($POM_VERSION)"
            echo ""
          else
            echo "âœ… Versions are synchronized"
          fi

  # ===========================================================================
  # Job 2: å‘å¸ƒåˆ° Maven Central
  # ===========================================================================
  publish:
    name: ğŸ“¦ Publish to Maven Central
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.dry_run != 'true'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag_name }}
          fetch-depth: 0

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: ğŸ” Configure GPG Agent
        run: |
          echo "ğŸ” Configuring GPG for non-interactive signing..."
          
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          
          cat > ~/.gnupg/gpg-agent.conf << EOF
          allow-loopback-pinentry
          allow-preset-passphrase
          default-cache-ttl 600
          max-cache-ttl 7200
          EOF
          
          cat > ~/.gnupg/gpg.conf << EOF
          use-agent
          pinentry-mode loopback
          no-tty
          EOF
          
          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent || true
          
          echo "ğŸ“‹ Available GPG keys:"
          gpg --list-secret-keys --keyid-format LONG || echo "   No keys found"
          
          echo "âœ… GPG configuration completed"

      - name: ğŸ”§ Verify Maven Environment
        run: |
          echo "ğŸ“‹ Maven version:"
          mvn --version
          echo ""
          echo "ğŸ“‹ Java version:"
          java --version

      - name: ğŸš€ Build and Publish
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   Publishing to Maven Central"
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          echo "   Skip Tests: ${{ needs.prepare.outputs.skip_tests }}"
          echo "   Deployment Timeout: ${{ needs.prepare.outputs.deployment_timeout }} minutes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è®¡ç®—è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
          TIMEOUT_SECONDS=$(( ${{ needs.prepare.outputs.deployment_timeout }} * 60 ))
          
          MAVEN_ARGS="${MAVEN_CLI_OPTS}"
          MAVEN_ARGS="${MAVEN_ARGS} -P release"
          
          if [ "${{ needs.prepare.outputs.skip_tests }}" = "true" ]; then
            MAVEN_ARGS="${MAVEN_ARGS} -DskipTests"
            echo "â­ï¸  Tests will be skipped"
          fi
          
          echo ""
          echo "ğŸ“¦ Starting Maven deploy..."
          echo ""
          
          # æ‰§è¡Œå‘å¸ƒï¼Œå¢åŠ è¶…æ—¶é…ç½®
          # central.publishing.deployment.timeout: éƒ¨ç½²ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
          # central.publishing.checksums.timeout: æ ¡éªŒå’ŒéªŒè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
          mvn clean deploy ${MAVEN_ARGS} -e \
            -Dgpg.passphrase="${MAVEN_GPG_PASSPHRASE}" \
            -Dcentral.publishing.deployment.timeout=${TIMEOUT_SECONDS} \
            -Dcentral.publishing.checksums.timeout=300
          
          echo ""
          echo "âœ… Successfully published to Maven Central!"
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      - name: âœ… Post-Publish Verification
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ“¦ Publish Completed Successfully!                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                â•‘"
          echo "â•‘  Published artifacts:                                          â•‘"
          echo "â•‘    â€¢ json-view-ext-parent:${VERSION}                            "
          echo "â•‘    â€¢ json-view-ext-core:${VERSION}                              "
          echo "â•‘    â€¢ json-view-ext-spring-boot-starter:${VERSION}               "
          echo "â•‘    â€¢ json-view-ext-spring-boot3-starter:${VERSION}              "
          echo "â•‘                                                                â•‘"
          echo "â•‘  Note: Artifacts may take 10-30 minutes to appear on           â•‘"
          echo "â•‘        Maven Central search.                                   â•‘"
          echo "â•‘                                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ===========================================================================
  # Job 3: å‘å¸ƒå¤±è´¥é€šçŸ¥
  # ===========================================================================
  notify-failure:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [prepare, publish]
    if: failure()

    steps:
      - name: ğŸš¨ Generate Failure Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   âŒ Maven Publish Workflow Failed                                 â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   Job Status:                                                      â•‘"
          echo "â•‘     â€¢ prepare: ${{ needs.prepare.result }}                                        "
          echo "â•‘     â€¢ publish: ${{ needs.publish.result }}                                        "
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ” Common Issues & Solutions:                                    â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   1. Deployment Timeout                                            â•‘"
          echo "â•‘      â€¢ Try increasing deployment_timeout in manual trigger         â•‘"
          echo "â•‘      â€¢ Check Maven Central status: https://status.maven.org        â•‘"
          echo "â•‘      â€¢ Verify if deployment actually succeeded on Central          â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   2. GPG Signing Failed                                            â•‘"
          echo "â•‘      â€¢ Check MAVEN_GPG_PRIVATE_KEY secret format                   â•‘"
          echo "â•‘      â€¢ Verify MAVEN_GPG_PASSPHRASE is correct                      â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   3. Maven Central Authentication Failed                           â•‘"
          echo "â•‘      â€¢ Verify OSSRH_USERNAME and OSSRH_TOKEN secrets               â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # ===========================================================================
  # Job 4: å‘å¸ƒæˆåŠŸé€šçŸ¥
  # ===========================================================================
  notify-success:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: [prepare, publish]
    if: success()

    steps:
      - name: âœ… Generate Success Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ‰ Maven Publish Completed Successfully!                         â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ“Œ Version: ${{ needs.prepare.outputs.version }}                                   "
          echo "â•‘   ğŸ·ï¸  Tag:     ${{ needs.prepare.outputs.tag_name }}                                   "
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ”— Maven Central (may take 10-30 min to sync):                   â•‘"
          echo "â•‘      https://search.maven.org/search?q=g:io.github.vennarshulytz   â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ“ Next Step: Run 'Create GitHub Release' workflow               â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"